<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticker Chat GaConMc</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:url("https://pomf2.lain.la/f/3qghdbbr.jpg") center/cover fixed;
}
#box{
  max-width:480px;
  margin:auto;
  background:rgba(255,255,255,.95);
  min-height:100vh;
  padding:10px;
}
#messages{
  height:55vh;
  overflow-y:auto;
  border:1px solid #ccc;
  padding:6px;
  background:#fff;
}
input, button{
  width:100%;
  padding:10px;
  margin-top:5px;
  box-sizing:border-box;
}
.msg{
  border-bottom:1px solid #eee;
  padding:6px 0;
  font-size:14px;
}
.msg-head{
  display:flex;
  justify-content:space-between;
}
.name{font-weight:bold}
.admin{color:red}
.kiemduyet{color:green}
.member{color:blue}
.msg.bot .name,.msg.bot .text{color:#ff5ca8}
.ctrls button{
  width:26px;height:26px;padding:0;font-size:13px;cursor:pointer;
}
.text{
  margin-top:4px;
  white-space:pre-line;
  word-break:break-word;
}
.notice{
  text-align:center;
  color:red;
  font-size:13px;
}
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:8px 14px;
  border-radius:20px;
  opacity:0;
  transition:.3s;
  z-index:9999;
}
.toast.show{opacity:1}

.mute-item{
  display:flex;
  justify-content:space-between;
  border-bottom:1px dashed #ddd;
  padding:5px 0;
  align-items:center;
}
.mute-item button{
  width:auto;
  padding:2px 8px;
  font-size:12px;
  margin:0;
}
</style>
</head>
<body>

<div id="box">

<div id="loginBox">
  <h3>ÄÄƒng nháº­p</h3>
  <input id="user" placeholder="TÃ i khoáº£n">
  <input id="pass" type="password" placeholder="Máº­t kháº©u">
  <button id="loginBtn">ÄÄƒng nháº­p</button>
  <hr>
  <button id="guestBtn">VÃ o vá»›i tÆ° cÃ¡ch Member</button>
</div>

<div id="chatBox" style="display:none">
  <h3 id="roleText"></h3>
  <button id="soundBtn">ğŸ”Š Ã‚m thanh: Báº¬T</button>

  <button id="toggleMuteBtn" style="display:none;margin:6px 0">
    ğŸš« Xem danh sÃ¡ch bá»‹ cháº·n
  </button>

  <div id="notice" class="notice"></div>

  <div id="muteBox" style="display:none;border:1px solid #f3c;padding:6px;margin-bottom:6px;background:#fff">
    <b>ğŸš« Danh sÃ¡ch ngÆ°á»i bá»‹ cháº·n</b>
    <div id="muteList" style="font-size:13px;margin-top:4px"></div>
  </div>

  <div id="messages"></div>
  <input id="msg" placeholder="Nháº­p tin nháº¯n">
  <button id="sendBtn">Gá»­i</button>
</div>

</div>

<audio id="notifySound" src="boa.mp3"></audio>

<script>
/** * PHáº¦N 1: LOGIC GIAO DIá»†N & ÄÄ‚NG NHáº¬P 
 */
let role="", name="";
let soundOn = localStorage.getItem("soundOn") !== "false";

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
  deviceId = crypto.randomUUID();
  localStorage.setItem("deviceId", deviceId);
}

loginBtn.onclick = () => {

  const u = user.value.trim();
  const p = pass.value.trim();

  /* ===== MAP TÃ€I KHOáº¢N -> Sá» (CÃ“ NHIá»„U) ===== */
  const USER_NUM = {
    "admin": 1,
    "admin3124": 8,
    "admin1409": 4,
    "admin1234": 6,

    "kiemduyetvien2007": 3,
    "kiemduyetsever2007": 2,
    "kiemduyet2007": 7
  };

  /* ===== MAP Máº¬T KHáº¨U -> Sá» (CÃ“ NHIá»„U) ===== */
  const PASS_NUM = {
    "admin7": 1,
    "140907": 5,
    "431676": 2,
    "137631": 8,

    "678678": 9,
    "321321": 3,
    "861461": 7
  };

  const uNum = USER_NUM[u];
  const pNum = PASS_NUM[p];

  if (uNum === 4 && pNum === 5) {
    role = "admin";
    name = "Admin";
    start();
    return;
  }

  if (uNum === 7 && pNum === 9) {
    role = "kiemduyet";
    name = "Kiá»ƒm Duyá»‡t ViÃªn";
    start();
    return;
  }

  alert("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u");
};

guestBtn.onclick=()=>{
  role="member";
  name="Member-"+Math.floor(Math.random()*1000);
  start();
};

function start(){
  loginBox.style.display="none";
  chatBox.style.display="block";
  roleText.innerText="Báº¡n lÃ : "+name;

  soundBtn.innerText = soundOn ? "ğŸ”Š Ã‚m thanh: Báº¬T" : "ğŸ”‡ Ã‚m thanh: Táº®T";
  soundBtn.onclick = ()=>{
    soundOn = !soundOn;
    localStorage.setItem("soundOn", soundOn);
    soundBtn.innerText = soundOn ? "ğŸ”Š Ã‚m thanh: Báº¬T" : "ğŸ”‡ Ã‚m thanh: Táº®T";
  };

  if(role === "admin" || role === "kiemduyet"){
    toggleMuteBtn.style.display = "block";
    toggleMuteBtn.onclick = ()=>{
      muteBox.style.display = (muteBox.style.display === "none" ? "block" : "none");
    };
  }

  // Khá»Ÿi táº¡o chat tá»« module
  window.initChat();
}

// HÃ m Toast thÃ´ng bÃ¡o nhanh
window.toast = (t) => {
  const d=document.createElement("div");
  d.className="toast";
  d.innerText=t;
  document.body.appendChild(d);
  setTimeout(()=>d.classList.add("show"),10);
  setTimeout(()=>{
    d.classList.remove("show");
    setTimeout(()=>d.remove(),300);
  },1500);
}
</script>

<script type="module">
/** * Giá» ngÆ°á»i Ä‘Ã³ nháº¯n */
function formatTime(ts){
  if(!ts || !ts.toMillis) return "";
  const d = new Date(ts.toMillis());
  return d.toLocaleTimeString("vi-VN", {
    hour: "2-digit",
    minute: "2-digit"
  });
}

/** * PHáº¦N 2: CORE FIREBASE & LOGIC CHAT 
 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, serverTimestamp,
  doc, getDoc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyAOqWngNA4k7bMi0c7rfBbXAHfcB2g9LJM",
  authDomain:"gaconmc.firebaseapp.com",
  projectId:"gaconmc",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const q = query(collection(db, "messages"), orderBy("time"));

window.initChat = () => {
  checkMuteStatus();

  // Láº¯ng nghe tin nháº¯n (ThÃªm & XÃ³a realtime)
  onSnapshot(q, snap => {
    snap.docChanges().forEach(c => {
      // 1. KHI CÃ“ TIN Má»šI
      if(c.type === "added"){
        const m = c.doc.data();
        if(soundOn && m.deviceId !== "bot"){
          notifySound.currentTime=0;
          notifySound.play().catch(()=>{});
        }

        const div = document.createElement("div");
        div.className = `msg ${m.role} ${m.deviceId==="bot"?"bot":""}`;
        div.id = "msg-" + c.doc.id; // GÃ¡n ID Ä‘á»ƒ dá»… xÃ³a tá»« xa
        div.innerHTML = `
          <div class="msg-head">
            <div class="name">${m.name}</div>
            <div class="ctrls">
              <button class="btn-copy">ğŸ“‹</button>
              ${(role === "admin" || role === "kiemduyet") ? `
                <button class="btn-del">âŒ</button>
                <button class="btn-mute">ğŸš«</button>
              ` : ""}
            </div>
          </div>
          <div class="text">${m.text}</div>
            <div style="font-size:11px;color:#999;margin-top:3px">
            ${formatTime(m.time)}
            </div>    
        `;

        // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt trong tin nháº¯n
        div.querySelector(".btn-copy").onclick = () => {
           navigator.clipboard.writeText(m.text);
           toast("ğŸ“‹ ÄÃ£ copy tin nháº¯n");
        };

        if(div.querySelector(".btn-del")){
          div.querySelector(".btn-del").onclick = () => window.delMsg(c.doc.id);
          div.querySelector(".btn-mute").onclick = () => window.muteUser(m.deviceId, m.name);
        }

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      // 2. KHI TIN NHáº®N Bá»Š XÃ“A (Sá»­a lá»—i quan trá»ng)
      if(c.type === "removed"){
        const el = document.getElementById("msg-" + c.doc.id);
        if(el) el.remove();
      }
    });
  });

  // Gá»­i tin nháº¯n
  sendBtn.onclick = async () => {
    if(!msg.value.trim()) return;
    
    // Kiá»ƒm tra cháº·n trÆ°á»›c khi gá»­i
    const mCheck = await getDoc(doc(db, "mute", deviceId));
    if(mCheck.exists()) return alert("Báº¡n Ä‘ang bá»‹ cháº·n chat!");

    await addDoc(collection(db, "messages"), {
      name, role, text: msg.value,
      deviceId, time: serverTimestamp()
    });
    msg.value = "";
  };
};

// --- CHá»¨C NÄ‚NG ADMIN ---

window.delMsg = async (id) => {
  if(confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tin nháº¯n nÃ y?")){
    await deleteDoc(doc(db, "messages", id));
    toast("ğŸ—‘ï¸ ÄÃ£ xÃ³a tin nháº¯n");
  }
};

window.muteUser = async (targetId, targetName) => {
  if(targetId === "bot") return;
  if(confirm(`Cháº·n ngÆ°á»i dÃ¹ng: ${targetName}?`)){
    await setDoc(doc(db, "mute", targetId), { name: targetName });
    toast(`ğŸš« ÄÃ£ cháº·n ${targetName}`);
  }
};

window.unmuteUser = async (targetId) => {
  await deleteDoc(doc(db, "mute", targetId));
  toast("âœ… ÄÃ£ bá» cháº·n");
};

// Láº¯ng nghe danh sÃ¡ch bá»‹ cháº·n (dÃ nh cho Admin xem)
if(role !== "member"){
  onSnapshot(collection(db, "mute"), snap => {
    muteList.innerHTML = "";
    snap.forEach(d => {
      const data = d.data();
      const div = document.createElement("div");
      div.className = "mute-item";
      div.innerHTML = `
        <span>${data.name}</span>
        <button onclick="unmuteUser('${d.id}')">Gá»¡ cháº·n</button>
      `;
      muteList.appendChild(div);
    });
  });
}

// Kiá»ƒm tra xem mÃ¡y hiá»‡n táº¡i cÃ³ Ä‘ang bá»‹ cháº·n khÃ´ng
async function checkMuteStatus(){
  if(role !== "member") return;
  const m = await getDoc(doc(db, "mute", deviceId));
  if(m.exists()){
    msg.disabled = true;
    sendBtn.disabled = true;
    notice.innerText = "ğŸš« Báº¡n Ä‘ang bá»‹ cháº·n chat";
  }
}

/**
 * PHáº¦N 3: BOT VÃ€ Lá»†NH /INFO (GIá»® NGUYÃŠN LOGIC Cá»¦A Báº N)
 */
let lastMemberTime = 0;
let lastStaffTime = 0;
let lastBotReplyTime = 0;

const IDLE = 300000;     // 5 phÃºt member im láº·ng
const COOLDOWN = 600000; // 10 phÃºt bot chá»‰ tráº£ lá»i 1 láº§n
const startTime = Date.now();

onSnapshot(q, async snap => {
  for (const c of snap.docChanges()) {
    if (c.type !== "added") continue;

    const m = c.doc.data();
    const msgTime = m.time?.toMillis ? m.time.toMillis() : Date.now();

    if (msgTime < startTime) continue;
    if (m.deviceId === "bot") continue;

    const now = Date.now();

    // Náº¿u admin hoáº·c kiá»ƒm duyá»‡t vá»«a nháº¯n â†’ reset bot
    if (m.role === "admin" || m.role === "kiemduyet") {
      lastStaffTime = now;
      return;
    }

    // Chá»‰ xá»­ lÃ½ member
    if (m.role !== "member") continue;

    lastMemberTime = now;

    const isStrange = /^Member-\d+$/.test(m.name);
    const isIdle = now - lastStaffTime > IDLE;

    // âŒ bot vá»«a tráº£ lá»i gáº§n Ä‘Ã¢y â†’ bá»
    if (now - lastBotReplyTime < COOLDOWN) continue;

    // âŒ khÃ´ng pháº£i member láº¡ hoáº·c chÆ°a idle Ä‘á»§ lÃ¢u
    if (!isStrange || !isIdle) continue;

    // âœ… BOT TRáº¢ Lá»œI 1 Láº¦N
    lastBotReplyTime = now;

    await addDoc(collection(db, "messages"), {
      name: "ğŸ¤– Bot",
      role: "admin",
      deviceId: "bot",
      time: serverTimestamp(),
      text: "HelloğŸ‘‹ Náº¿u báº¡n nháº¯n mÃ  khÃ´ng ai tráº£ lá»i thÃ¬ cháº¯c cÃ¡c Kiá»ƒm Duyá»‡t ViÃªn Ä‘ang báº­n Ã¡, báº¡n Ä‘á»£i 1 tÃ­ sáº½ cÃ³ ngÆ°á»i tráº£ lá»i liá»n. Hoáº·c báº¡n cÃ³ thá»ƒ liÃªn há»‡ vá»›i Support bÃªn mÃ¬nh qua Facebook!"
    });

    await addDoc(collection(db, "messages"), {
      name: "ğŸ¤– Bot",
      role: "admin",
      deviceId: "bot",
      time: serverTimestamp(),
      text: "https://www.facebook.com/100069576183683"
    });
  }
});

/* ================= ğŸ“Œ Lá»‡nh /Info â€“ FIX SPAM TUYá»†T Äá»I ================= */

const handledInfoMessages = new Set();

onSnapshot(q, async snap => {

  // â— chá»‰ ADMIN Ä‘iá»u khiá»ƒn bot
  if (!["admin","kiemduyet","member"].includes(role)) return;

  for (const c of snap.docChanges()) {
    if (c.type !== "added") continue;

    // âŒ náº¿u tin nÃ y Ä‘Ã£ xá»­ lÃ½ rá»“i â†’ bá»
    if (handledInfoMessages.has(c.doc.id)) continue;

    const m = c.doc.data();
    const msgTime = m.time?.toMillis ? m.time.toMillis() : Date.now();

    // âŒ bá» qua bot / tin trá»‘ng / tin cÅ©
    if (m.deviceId === "bot" || !m.text || msgTime < startTime) continue;

    // âŒ khÃ´ng pháº£i /info
    if (m.text.trim().toLowerCase() !== "/info") continue;

    // âœ… ÄÃNH Dáº¤U ÄÃƒ Xá»¬ LÃ
    handledInfoMessages.add(c.doc.id);

    await addDoc(collection(db, "messages"), {
      name: "ğŸ¤– Bot",
      role: "admin",
      deviceId: "bot",
      time: serverTimestamp(),
      text: `ğŸ“Œ INFO CÃC CHá»¨C Vá»¤ SERVER

ğŸ‘¤ Admin ChÃ­nh:
ğŸ‘‰ Facebook: https://www.facebook.com/profile.php?id=61583009645768

ğŸ‘¤ Admin Phá»¥:
ğŸ‘‰ Facebook: https://www.facebook.com/thu.trang.1401207

ğŸ‘¤ CÃ¡c QTV:
ğŸ‘‰ Facebook: https://www.facebook.com/MrSomeOne1
ğŸ‘‰ Facebook: https://www.facebook.com/profile.php?id=61582928121714

ğŸ‘¤ CÃ¡c Support:
ğŸ‘‰ Facebook: https://www.facebook.com/le.tuan.anh.347063
ğŸ‘‰ Facebook: https://www.facebook.com/nguyen.chi.anh.853868
ğŸ‘‰ Facebook: https://www.facebook.com/profile.php?id=61574102743872

â¤ï¸ HÃ£y liÃªn há»‡ nhá»¯ng ngÆ°á»i trÃªn Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ â¤ï¸`
    });
  }
});

/* ==================================================================== */
</script>

</body>
</html>
