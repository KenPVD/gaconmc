<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Ticker GaConMC</title>
    <style>
        :root {
            --primary-color: #ff5ca8;
            --admin-color: #e74c3c;
            --kd-color: #2ecc71;
            --member-color: #3498db;
            --my-msg-bg: #e1f5fe;
            --other-msg-bg: #ffffff;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: url("https://pomf2.lain.la/f/3qghdbbr.jpg") center/cover fixed;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #box {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        #toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 10000;
            display: none;
            animation: fadeInOut 2s ease forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                top: 10px;
            }

            15% {
                opacity: 1;
                top: 20px;
            }

            85% {
                opacity: 1;
                top: 20px;
            }

            100% {
                opacity: 0;
                top: 10px;
            }
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(240, 242, 245, 0.3);
        }

        .msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.me {
            align-self: flex-end;
            background: var(--my-msg-bg);
            border-bottom-right-radius: 4px;
        }

        .msg.other,
        .msg.bot {
            align-self: flex-start;
            background: var(--other-msg-bg);
            border-bottom-left-radius: 4px;
        }

        .msg.bot {
            border-left: 4px solid var(--primary-color);
        }

        .bot .name,
        .bot .text {
            color: var(--primary-color);
        }

        .msg-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }

        .name {
            font-weight: bold;
            font-size: 11px;
            text-transform: uppercase;
        }

        .admin .name {
            color: var(--admin-color);
        }

        .kiemduyet .name {
            color: var(--kd-color);
        }

        .member .name {
            color: var(--member-color);
        }

        .text {
            font-size: 14px;
            color: #222;
            word-break: break-word;
            line-height: 1.5;
            white-space: pre-line;
        }

        .msg-time {
            font-size: 9px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .ctrls {
            display: flex;
            gap: 5px;
        }

        .ctrls button {
            border: none;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 5px;
            padding: 3px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .input-wrap {
            display: flex;
            align-items: center;
            background: #f0f2f5;
            border-radius: 25px;
            padding: 5px 15px;
            gap: 10px;
        }

        #msg {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 0;
            outline: none;
            font-size: 14px;
        }

        #sendBtn {
            width: 100%;
            margin-top: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .header-btns {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sound-btn {
            font-size: 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            padding: 4px 8px;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 35px;
            height: 35px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Khung Login Staff m√†u xanh d∆∞∆°ng nh·∫°t */
        .admin-login-card {
            margin-top: 15px;
            border: 1px solid #d1e3f8 !important;
            /* Vi·ªÅn xanh nh·∫°t */
            border-radius: 12px !important;
            background: #ffffff;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
            /* ƒê·ªï b√≥ng √°nh xanh */
        }

        .admin-login-card summary {
            font-size: 11px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #3498db;
            /* Ch·ªØ m√†u xanh d∆∞∆°ng */
            background: #f0f7ff;
            /* N·ªÅn xanh c·ª±c nh·∫°t */
            list-style: none;
            font-weight: bold;
            transition: 0.3s;
            border-bottom: 1px solid #d1e3f8;
        }

        .admin-login-card summary:hover {
            background: #e1effe;
            color: #2980b9;
        }

        .login-form-inner {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #ffffff;
        }

        .login-form-inner input {
            padding: 10px 12px;
            border: 1px solid #d1e3f8;
            border-radius: 8px;
            outline: none;
            font-size: 13px;
            transition: 0.3s;
            background: #fcfdfe;
        }

        .login-form-inner input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            background: #ffffff;
        }

        #staffLoginBtn {
            padding: 10px;
            background: #3498db;
            /* N√∫t m√†u xanh ch·ªß ƒë·∫°o */
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        #staffLoginBtn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        #staffLoginBtn:active {
            transform: translateY(0);
        }

        /* h·ªó tr·ª£ ch·ªØ ƒë·ªÉ ƒë·∫©y ƒëƒÉng nh·∫≠p l√™n */
        .admin-login-note {
            background: #d9edfa;
            border: 3px solid #fffb00;
            color: #0077ff;

            padding: 6px 16px;
            border-radius: 14px;

            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

            font-size: 16px;
            font-weight: 800;
            /* üî• IN ƒê·∫¨M R√ï */
            letter-spacing: 0.4px;
            line-height: 1.6;

            text-align: center;

            margin-top: 10px;
            margin-bottom: -2px;

            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        /* M√†u link xanh, kh√¥ng g·∫°ch ch√¢n */
        .chat-link {
            color: #0084ff;
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
            /* Tr√°nh tr√†n khung n·∫øu link qu√° d√†i */
            transition: color 0.2s;
        }

        /* ===== FIX INPUT + N√öT G·ª¨I NH·ªé G·ªåN ===== */
        .input-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f0f2f5;
            border-radius: 25px;
        }

        #msg {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
        }

        /* N√öT G·ª¨I TR√íN NH·ªé */
        #sendBtn.send-inline {
            width: 34px !important;
            height: 34px !important;
            min-width: 34px;
            padding: 0 !important;
            margin: 0 !important;

            border-radius: 50%;
            border: none;
            background: #ff5ca8;
            color: white;

            display: flex;
            align-items: center;
            justify-content: center;

            font-size: 14px;
            cursor: pointer;
        }

        #sendBtn.send-inline:active {
            transform: scale(0.9);
        }

        /* ===== AVATAR GROUP ===== */
        #groupAvatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;

            border: 2px solid #3498db;
            /* m·∫∑c ƒë·ªãnh Member */
            background: #fff;
        }

        /* ===== EMOJI BUTTON ===== */
        .emoji-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;

            border-radius: 50%;
            border: none;
            background: #ffe6f0;
            color: #ff5ca8;

            display: flex;
            align-items: center;
            justify-content: center;

            font-size: 15px;
            cursor: pointer;
        }

        .emoji-btn:active {
            transform: scale(0.9);
        }

        /* b·∫£ng emoji n·ªïi ngay tr√™n n√∫t */
        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 72px;
            right: 55px;
            /* canh ngay tr√™n n√∫t emoji */

            background: white;
            border-radius: 14px;
            padding: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);

            font-size: 20px;
            line-height: 1.6;
            z-index: 999;
        }

        .emoji-picker span {
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            display: inline-block;
        }

        .emoji-picker span:hover {
            background: #ffe6f0;
            transform: scale(1.2);
        }

        /* ===== INPUT B·ªä CH·∫∂N ===== */
        .input-wrap.muted {
            background: #ffecec;
            border: 1px solid #e74c3c;
        }

        .input-wrap.muted #msg {
            color: #e74c3c;
            font-weight: bold;
        }

        .input-wrap.muted #msg::placeholder {
            color: #e74c3c;
            opacity: 1;
        }

        .input-wrap.muted #sendBtn,
        .input-wrap.muted .emoji-btn {
            background: #ccc !important;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ===== Xo√° tin nh·∫Øn ===== */
        .deleted-msg {
            color: #999;
            font-style: italic;
            font-size: 13px;
        }
    </style>
</head>

<body>

    <div id="nicknameModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:99999; align-items:center; justify-content:center; backdrop-filter: blur(4px);">
        <div
            style="background:white; padding:30px; border-radius:20px; width:90%; max-width:360px; box-shadow:0 15px 35px rgba(0,0,0,0.2); text-align:center;">
            <h2 style="margin:0 0 10px 0; color:#333; font-size:18px;">‚ú® ƒê·∫∑t bi·ªát danh</h2>
            <p id="targetInfo" style="font-size:12px; color:#777; margin-bottom:15px;"></p>
            <input type="text" id="newNicknameInput"
                style="width:100%; padding:12px; border:2px solid #eee; border-radius:10px; margin-bottom:15px; outline:none; font-size:15px; box-sizing:border-box;">
            <div style="display:flex; gap:10px;">
                <button onclick="window.closeNicknameModal()"
                    style="flex:1; padding:10px; border:none; border-radius:8px; background:#eee; cursor:pointer;">H·ªßy</button>
                <button id="confirmNicknameBtn"
                    style="flex:1; padding:10px; border:none; border-radius:8px; background:#ff5ca8; color:white; cursor:pointer;">X√°c
                    nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="font-size: 13px; color: #666; margin-top: 10px;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <div id="box">
        <div id="chatBox" style="display:none; height: 100%; flex-direction: column;">
            <div
                style="padding: 12px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div id="accountInfo" style="display:flex; align-items:center; gap:8px;">
                        <img id="groupAvatar" src="https://pomf2.lain.la/f/k7lr1rw.jpg">
                        <span id="roleText" style="font-weight:bold; font-size:14px; color:#333;"></span>
                    </div>
                    <button id="logoutBtn" style="display:none">ƒêƒÉng xu·∫•t</button>
                    <!-- CH·ªà ADMIN M·ªöI TH·∫§Y -->
                </div>

                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                </div>


                <div class="header-btns">
                    <div class="header-btns">

                        <button id="soundToggle" class="sound-btn">üîä</button>

                        <button id="adminChatToggle"
                            style="display:none; font-size: 11px; padding: 4px 8px; border-radius: 5px; border: 1px solid #e74c3c; background: white; color: #e74c3c; cursor: pointer; font-weight: bold; margin-right: 5px;">üîí
                            KH√ìA CHAT</button>

                        <button id="toggleMuteBtn"
                            style="display:none; font-size: 11px; padding: 4px 8px; border-radius: 5px; border: 1px solid #ddd; background: white; cursor: pointer;">üö´
                            DS Ch·∫∑n</button>
                    </div>

                </div>
            </div>

            <div id="muteBox"
                style="display:none; padding: 10px; background: #fff5f8; border-bottom: 1px solid #ff5ca8;">
                <b style="font-size: 12px; color: #ff5ca8;">Ng∆∞·ªùi d√πng b·ªã ch·∫∑n:</b>
                <div id="muteList" style="max-height: 80px; overflow-y: auto;"></div>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <div id="notice"
                    style="color:red; font-size: 11px; margin-bottom: 6px; text-align: center; font-weight: bold;">
                </div>
                <div id="replyBox" style="display:none;
     background:#f0f2f5;
     padding:6px 10px;
     border-left:4px solid #ff5ca8;
     margin-bottom:6px;
     border-radius:6px;
     font-size:12px;">
                    <span id="replyText"></span>
                    <button onclick="clearReply()"
                        style="float:right;border:none;background:none;cursor:pointer">‚úñ</button>
                </div>
                <form id="chatForm" onsubmit="return false;">
                    <div class="input-wrap">
                        <input id="msg" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">

                        <!-- N√öT EMOJI -->
                        <button id="emojiBtn" class="emoji-btn" type="button">üòä</button>
                        <!-- N√öT G·ª¨I -->
                        <button id="sendBtn" class="send-inline">‚û§</button>
                    </div>
                    <div id="emojiPicker" class="emoji-picker">
                        <span>üòÄ</span><span>üòÅ</span><span>üòÇ</span><span>ü§£</span>
                        <span>üòä</span><span>üòç</span><span>üòò</span><span>üò≠</span>
                        <span>üò°</span><span>üëç</span><span>üëé</span><span>‚ù§Ô∏è</span>
                        <span>üî•</span><span>üéÆ</span><span>üéß</span><span>‚öΩ</span><span>üèÜ</span>
                    </div>


                </form>
                <details class="admin-login-card" id="loginDetails">
                    <summary>‚ñº üîê ƒêƒÇNG NH·∫¨P ADMIN / KI·ªÇM DUY·ªÜT VI√äN</summary>
                    <div class="login-form-inner">
                        <input id="staffUser" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                        <input id="staffPass" type="password" placeholder="M·∫≠t kh·∫©u">
                        <button id="staffLoginBtn">ƒêƒÉng Nh·∫≠p</button>
                    </div>
                </details>

                <!-- üëá D√íNG CH·ªÆ M·ªöI -->
                <div class="admin-login-note">
                    ‚≠êTICKER CHAT SERVER GCMC‚≠ê
                </div>
                </details>
            </div>
        </div>
    </div>

    <audio id="notifySound" src="boa.mp3" preload="auto"></audio>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc, deleteDoc, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVXOhs89BInPESHw1uAWalHJZ64YHotX0",
            authDomain: "pvdai-e7fb1.firebaseapp.com",
            projectId: "pvdai-e7fb1",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let replyData = null; // üëà B·∫ÆT BU·ªòC ‚Äì FIX REPLY
        let role = (localStorage.getItem("userRole") || "member").toLowerCase();
        let name = localStorage.getItem("memberName") || "Member-" + Math.floor(Math.random() * 10000);
        let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
        let isSoundEnabled = localStorage.getItem("soundOn") !== "false";
        const startTime = Date.now();
        const msgContainer = document.getElementById('messages');
        const scrollToBottom = () => { msgContainer.scrollTop = msgContainer.scrollHeight; };

        localStorage.setItem("memberName", name);
        localStorage.setItem("deviceId", deviceId);

        window.showToast = (t) => {
            const el = document.getElementById('toast');
            el.innerText = t; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        };

        const soundBtn = document.getElementById('soundToggle');
        soundBtn.innerText = isSoundEnabled ? "üîä" : "üîá";
        soundBtn.onclick = () => {
            isSoundEnabled = !isSoundEnabled;
            localStorage.setItem("soundOn", isSoundEnabled);
            soundBtn.innerText = isSoundEnabled ? "üîä" : "üîá";
        };

        const qMessages = query(collection(db, "messages"), orderBy("time"), limitToLast(100));

        // L·∫Øng nghe tin nh·∫Øn ƒë·ªÉ hi·ªÉn th·ªã UI
        onSnapshot(qMessages, (snap) => {
            snap.docChanges().forEach((change) => {
                const data = change.doc.data();
                const id = change.doc.id;
                // üî• FIX XO√Å TIN REALTIME (KH√îNG C·∫¶N RELOAD)
                if (change.type === "modified") {
                    const el = document.getElementById("msg-" + id);
                    if (!el) return;

                    // ‚úÖ UPDATE TEXT
                    const textBox = el.querySelector(".text");
                    if (textBox) {
                        if (data.deleted) {
                            textBox.innerHTML = "üö´ Tin nh·∫Øn ƒë√£ b·ªã x√≥a";
                            textBox.classList.add("deleted-msg");
                        } else {
                            textBox.innerHTML = formatText(data.text || "");
                            textBox.classList.remove("deleted-msg");
                        }
                    }

                    // ‚úÖ UPDATE NAME REALTIME
                    const nameBox = el.querySelector(".name");
                    if (nameBox && data.name) {
                        nameBox.innerText = data.name;
                    }
                }
                if (change.type === "added") {
                    const isMe = data.deviceId === deviceId;
                    const div = document.createElement("div");
                    div.className = `msg ${isMe ? 'me' : 'other'} ${data.role} ${data.deviceId === 'bot' ? 'bot' : ''}`;
                    div.id = "msg-" + id;
                    div.dataset.id = id; // ‚≠ê TH√äM D√íNG N√ÄY
                    div.innerHTML = `
    <div class="msg-head">
        <span class="name" id="name-${id}">${data.name}</span>
        <div class="ctrls">
            <button onclick="copyTxt('${(data.text || '').replace(/'/g, "\\'")}')">üìã</button>
            <button onclick="setReply('${id}', '${data.name}', '${(data.text || "").replace(/'/g, "\\'")}')">‚Ü©Ô∏è</button>
            <button onclick="window.setNickname('${id}', '${data.deviceId}', '${data.role}', '${data.name}')">‚úèÔ∏è</button>

            ${(
                            role === "admin" ||
                            role === "kiemduyet" ||
                            (role === "member" && data.deviceId === deviceId)
                        ) ? `
    <button onclick="window.delMsg('${id}')" style="color:red">‚ùå</button>
` : ''}
${(role === "admin" || role === "kiemduyet") ? `
    <button onclick="window.muteUser('${data.deviceId}','${data.name}')" style="color:orange">üö´</button>
` : ''}
        </div>
    </div>
    ${data.reply ? `
  <div
     class="reply-preview"
     onclick="scrollToMsg('${data.reply.msgId}')"
     style="
       background:#eee;
       padding:6px;
       border-left:3px solid #ff5ca8;
       border-radius:6px;
       font-size:12px;
       margin-bottom:4px;
       cursor:pointer;">
     <b>${data.reply.name}</b>: ${data.reply.text}
  </div>
` : ""}
    <div class="text ${data.deleted ? 'deleted-msg' : ''}">${data.deleted ? 'üö´ Tin nh·∫Øn c·ªßa b·∫°n ƒë√£ b·ªã x√≥a' : formatText(data.text || "")}</div>

    <div class="msg-time">${data.time ? new Date(data.time.toMillis()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'V·ª´a xong'}</div>
`;
                    document.getElementById('messages').appendChild(div);
                    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                    if (!isMe && isSoundEnabled && data.deviceId !== "bot" && data.time?.toMillis() > Date.now() - 5000) {
                        document.getElementById('notifySound').play().catch(() => { });
                    }
                }
                if (change.type === "removed") document.getElementById("msg-" + id)?.remove();
            });
        });
        /* =========================================================
           BOT COMMAND SYSTEM (ANTI SPAM ‚Äì ANTI RELOAD ‚Äì ANTI MULTI TAB)
           ========================================================= */

        // üìú DANH S√ÅCH L·ªÜNH (th√™m l·ªánh m·ªõi ch·ªâ c·∫ßn th√™m d√≤ng)
        const BOT_COMMANDS = {
            "/info": {
                text: `üìå INFO C√ÅC QU·∫¢N TR·ªä SERVER

üë§ Admin Ch√≠nh:
üëâ FB: https://www.facebook.com/profile.php?id=61583009645768

üë§ Admin Ph·ª•:
üëâ FB: https://www.facebook.com/thu.trang.1401207

üë§ C√°c QTV:
üëâ FB: https://www.facebook.com/MrSomeOne1
üëâ FB: https://www.facebook.com/profile.php?id=61582928121714

üë§ C√°c Support:
üëâ FB: https://www.facebook.com/nguyen.chi.anh.853868
üëâ FB: https://www.facebook.com/le.tuan.anh.347063
üëâ FB: https://www.facebook.com/profile.php?id=61574102743872
üëâ FB: https://www.facebook.com/profile.php?id=61578659525630

‚ù§Ô∏è Li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ ‚ù§Ô∏è`,
                roles: ["member", "admin", "kiemduyet"]
            },

            "/ip": {
                text: `IP Sever hi·ªán t·∫°i
Pc: gaconmc.ddns.net:25026
Pe: gaconmc.ddns.net
Port: 25026

Link Bio Sever
https://kenpvd.github.io/gaconmc/`,
                roles: ["admin", "kiemduyet"] // üëà CH·ªà 2 ROLE N√ÄY
            },

            "/luat": {
                text: `LU·∫¨T SEVER G√Ä CON MC
1. Kh√¥ng ph√° base ph√° m√°y farm c·ªßa ng∆∞·ªùi kh√°c
2. C√≥ l·ªánh b·∫≠t t·∫Øt pvp, ai b·∫≠t pvp m√† b·ªã bƒÉm bay gi√°p t·ª± ch·ªãu
3. L√†m phi·ªÅn ng∆∞·ªùi kh√°c ch∆°i g√¢y kh√≥ ch·ªãu nh·∫Øc kh√¥ng nghe tempban l·∫ßn 1 1h, l·∫ßn 2 12h, l·∫ßn 3 24h, l·∫ßn 4 vƒ©nh vi·ªÖn (Ho·∫∑c sau l·∫ßn 1 n·∫øu c√≤n ph√° h∆°n Admin v√† QTV ban th·∫≥ng vƒ©nh vi·ªÖn)
4. Kh√¥ng d√πng mod, hack, X-ray ƒë·ªÉ gian l·∫≠n
5. M·ªùi b·∫°n b√®, th√†nh vi√™n th√¨ tr∆∞·ªõc ti√™n ph·∫£i m·ªùi v√¥ box mess tr∆∞·ªõc
6. Kh√¥ng tr·ªôm c·∫Øp ƒë·ªì trong r∆∞∆°ng v√† ƒë·ªì ·ªü ngo√†i (C√°c member c≈©ng kh√¥ng n√™n ƒë·ªÉ ƒë·ªì quan tr·ªçng trong r∆∞∆°ng. R·∫•t kh√≥ t√¨m th·ªß ph·∫°m, ko bi·∫øt th·ªß ph·∫°m Ad kh√¥ng ch·ªãu tr√°ch nhi·ªám)
7. Lu·∫≠t theo √Ω th·ª©c c·ªßa m·ªói ng∆∞·ªùi ch∆°i
ƒê·ªçc R√µ Lu·∫≠t Tr√°ch M·∫•t L√≤ng Nhau!`,
                roles: ["member", "admin", "kiemduyet"]
            },
            "/logoutall": {
                text: "üö® Admin ƒë√£ y√™u c·∫ßu ƒëƒÉng xu·∫•t TO√ÄN B·ªò Admin & Ki·ªÉm Duy·ªát!",
                roles: ["admin"] // ‚ùó CH·ªà ADMIN
            }
        };

        // üõ°Ô∏è ch·ªëng spam & reload
        const handledCmd = new Set();   // m·ªói tin x·ª≠ l√Ω 1 l·∫ßn
        let lastCmdTime = 0;            // cooldown theo thi·∫øt b·ªã
        const CMD_COOLDOWN = 5000;      // 5 gi√¢y

        onSnapshot(qMessages, async (snap) => {
            for (const c of snap.docChanges()) {
                if (c.type !== "added") continue;

                const m = c.doc.data();
                const mid = c.doc.id;

                // ‚ùå b·ªè tin c≈©, bot, tin ƒë√£ x·ª≠ l√Ω
                if (m.time && m.time.toMillis() < startTime) continue;
                if (m.deviceId === "bot") continue;
                if (handledCmd.has(mid)) continue;

                const cmd = m.text?.trim().toLowerCase();
                const command = BOT_COMMANDS[cmd];
                if (!command) continue;

                // ‚ùå CH·∫∂N ROLE KH√îNG ƒê∆Ø·ª¢C PH√âP
                if (!command.roles.includes(m.role)) {
                    // ch·ªâ bot g·ª≠i c·∫£nh b√°o 1 l·∫ßn cho ng∆∞·ªùi g√µ
                    if (m.deviceId === deviceId) {
                        await addDoc(collection(db, "messages"), {
                            name: "ü§ñ Bot",
                            role: "admin",
                            deviceId: "bot",
                            time: serverTimestamp(),
                            text: "‚õî L·ªánh n√†y ch·ªâ d√†nh cho Admin / Ki·ªÉm duy·ªát."
                        });
                    }
                    continue;
                }
                if (cmd === "/logoutall") {
                    // ‚ùó CH·ªà client G·ª¨I TIN n√†y m·ªõi x·ª≠ l√Ω
                    if (m.role !== "admin") continue;
                    if (m.deviceId !== deviceId) continue;

                    const ref = doc(db, "settings", "logoutAll");
                    const snap = await getDoc(ref);
                    const ver = snap.exists() ? (snap.data().ver || 0) : 0;

                    await setDoc(ref, {
                        ver: ver + 1,
                        by: m.name,
                        time: serverTimestamp()
                    });

                    await addDoc(collection(db, "messages"), {
                        name: "ü§ñ Bot",
                        role: "admin",
                        deviceId: "bot",
                        time: serverTimestamp(),
                        text: "üö® Admin ƒë√£ ƒëƒÉng xu·∫•t TO√ÄN B·ªò Admin & Ki·ªÉm Duy·ªát!"
                    });

                    continue;
                }
                handledCmd.add(mid);
                const now = Date.now();
                // üîí ch·ªâ TAB g·ª≠i l·ªánh m·ªõi ƒë∆∞·ª£c bot tr·∫£ l·ªùi + cooldown
                if (m.deviceId !== deviceId) continue;
                if (now - lastCmdTime < CMD_COOLDOWN) continue;

                lastCmdTime = now;

                try {
                    await addDoc(collection(db, "messages"), {
                        name: "ü§ñ Bot",
                        role: "admin",
                        deviceId: "bot",
                        time: serverTimestamp(),
                        text: command.text
                    });
                } catch (e) {
                    console.error("BOT CMD ERROR:", e);
                }
            }
        });

        /* ==================================================================== 
               BOT PH·∫¶N 2: PH·∫¢N H·ªíI MEMBER L·∫† & T·ª∞ ƒê·ªòNG NH·∫ÆC SAU 5 PH√öT (FIX SPAM RELOAD)
               ==================================================================== */
        let lastBotReplyTime = Number(localStorage.getItem("lastBotReplyTime") || 0);
        const processedAuto = new Set();
        const BOT_COOLDOWN = 300000; // 5 ph√∫t

        onSnapshot(qMessages, async snap => {
            const docChanges = snap.docChanges().filter(c => c.type === "added");

            for (const c of docChanges) {
                const m = c.doc.data();
                const mid = c.doc.id;

                // 1. CH·∫∂N SPAM RELOAD: Ch·ªâ x·ª≠ l√Ω tin nh·∫Øn g·ª≠i SAU KHI trang ƒë√£ load xong
                const mTime = m.time?.toMillis ? m.time.toMillis() : Date.now();
                if (mTime < startTime) continue;

                // 2. Tr√°nh x·ª≠ l√Ω tr√πng v√† b·ªè qua Bot
                if (processedAuto.has(mid) || m.deviceId === "bot") continue;
                processedAuto.add(mid);

                // 3. N·∫øu Staff nh·∫Øn tin -> Reset th·ªùi gian ch·ªù
                if (m.role === "admin" || m.role === "kiemduyet") {
                    lastBotReplyTime = Date.now();
                    localStorage.setItem("lastBotReplyTime", lastBotReplyTime); // ‚≠ê FIX
                    continue;
                }
                // 4. LOGIC K√çCH HO·∫†T QUAN TR·ªåNG
                const now = Date.now();
                const isMemberLage = m.name && m.name.includes("Member-");
                const isOver5Min = (now - lastBotReplyTime) > BOT_COOLDOWN;

                // ‚ùå N·∫æU L√Ä L·ªÜNH (b·∫Øt ƒë·∫ßu b·∫±ng /) ‚Üí KH√îNG AUTO REP
                if (m.text && m.text.trim().startsWith("/")) {
                    lastBotReplyTime = Date.now();
                    localStorage.setItem("lastBotReplyTime", lastBotReplyTime); // ‚≠ê FIX
                    continue;
                }
                /* ƒêI·ªÄU KI·ªÜN CH·ªêNG SPAM KHI NHI·ªÄU NG∆Ø·ªúI C√ôNG ONLINE:
                   Ch·ªâ m√°y c·ªßa ng∆∞·ªùi v·ª´a g·ª≠i tin nh·∫Øn (m.deviceId === deviceId) 
                   m·ªõi ƒë∆∞·ª£c quy·ªÅn ra l·ªánh cho Bot ph·∫£n h·ªìi.
                */
                const isCommand = m.text && m.text.trim().startsWith("/");
                if (isMemberLage && isOver5Min && m.deviceId === deviceId && !isCommand) {
                    lastBotReplyTime = now;
                    localStorage.setItem("lastBotReplyTime", lastBotReplyTime); // ‚≠ê FIX

                    try {
                        // G·ª¨I TIN 1
                        await addDoc(collection(db, "messages"), {
                            name: "ü§ñ Bot",
                            role: "admin",
                            deviceId: "bot",
                            time: serverTimestamp(),
                            text: "Helloüëã N·∫øu b·∫°n nh·∫Øn m√† kh√¥ng ai tr·∫£ l·ªùi th√¨ ch·∫Øc c√°c Ki·ªÉm Duy·ªát Vi√™n ƒëang b·∫≠n √°, b·∫°n ƒë·ª£i 1 t√≠ s·∫Ω c√≥ ng∆∞·ªùi tr·∫£ l·ªùi li·ªÅn. Ho·∫∑c b·∫°n c√≥ th·ªÉ li√™n h·ªá v·ªõi Support b√™n m√¨nh qua Facebook!"
                        });

                        await new Promise(res => setTimeout(res, 800)); // ƒê·ª£i m·ªôt ch√∫t

                        // G·ª¨I TIN 2
                        await addDoc(collection(db, "messages"), {
                            name: "ü§ñ Bot",
                            role: "admin",
                            deviceId: "bot",
                            time: serverTimestamp(),
                            text: "https://www.facebook.com/100069576183683"
                        });
                    } catch (e) {
                        console.error("Bot g·ª≠i tin l·ªói:", e);
                    }
                }
            }
        });

        // --- copy ---
        window.copyTxt = (t) => {
            navigator.clipboard.writeText(t).then(() => showToast("‚úÖ ƒê√£ copy!"));
        };
        // --- xo√° tin nh·∫Øn ---
        window.delMsg = async (id) => {
            if (!confirm("X√≥a tin nh·∫Øn n√†y?")) return;
            await setDoc(
                doc(db, "messages", id),
                {
                    text: "üö´ Tin nh·∫Øn c·ªßa b·∫°n ƒë√£ b·ªã x√≥a",
                    deleted: true
                },
                { merge: true }
            );
        };
        window.muteUser = async (tid, tname) => {
            if (tid === "bot" || tid === deviceId) return;
            if (confirm(`Ch·∫∑n ${tname}?`)) await setDoc(doc(db, "mute", tid), { name: tname });
        };

        const sendMsg = async (text) => {
            // 1. Ki·ªÉm tra ch·∫∑n c√° nh√¢n
            const mCheck = await getDoc(doc(db, "mute", deviceId));
            if (mCheck.exists()) return alert("B·∫°n b·ªã ch·∫∑n!");

            // 2. Ki·ªÉm tra kh√≥a chat to√†n server
            // Cho ph√©p 'admin' v√† 'kiemduyet' g·ª≠i tin nh·∫Øn k·ªÉ c·∫£ khi ƒëang kh√≥a
            if (isChatLocked && role === "member") {
                return alert("Ph√≤ng chat ƒëang kh√≥a, b·∫°n kh√¥ng th·ªÉ g·ª≠i tin l√∫c n√†y!");
            }

            await addDoc(collection(db, "messages"), {
                name,
                role,
                text,
                deviceId,
                reply: replyData,
                time: serverTimestamp()
            });
            clearReply(); // üëà G·ª¨I XONG L√Ä CLEAR
        };

        document.getElementById('sendBtn').onclick = () => {
            const input = document.getElementById('msg');
            const text = input.value.trim();

            if (text === "") {
                // Kh√¥ng c√≥ ch·ªØ ‚Üí g·ª≠i emoji m·∫∑c ƒë·ªãnh
                sendMsg("üê•"); // ‚Üê ƒë·ªïi emoji t√πy b·∫°n
            } else {
                // C√≥ ch·ªØ ‚Üí g·ª≠i b√¨nh th∆∞·ªùng
                sendMsg(text);
            }

            input.value = "";
        };
        document.getElementById('staffLoginBtn').onclick = () => {
            const u = document.getElementById('staffUser').value.trim();
            const p = document.getElementById('staffPass').value.trim();

            const suffix = Math.floor(Math.random() * 10000); // s·ªë xxx

            if (u === "admin1409" && p === "140907") {
                role = "admin";
                name = "Admin";
            }
            else if (u === "kiemduyet2007" && p === "678678") {
                role = "kiemduyet";
                name = "KiemDuyetVien-" + suffix;
            }
            else {
                return alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
            }

            localStorage.setItem("userRole", role);
            localStorage.setItem("memberName", name);
            location.reload();
        };
        document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); location.reload(); };

        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('chatBox').style.display = 'flex';
            document.getElementById('roleText').innerText = "üü¢‚îÇT√†i Kho·∫£n: " + name;
            // Th√™m d√≤ng n√†y v√†o ƒë√¢y
            scrollToBottom();
            if (role !== "member") {
                document.getElementById('logoutBtn').style.display = "inline-block";
                document.getElementById('toggleMuteBtn').style.display = "inline-block";
                document.getElementById('loginDetails').style.display = "none";
            }
            // üëë CH·ªà ADMIN M·ªöI TH·∫§Y ƒêƒÇNG XU·∫§T ALL
            if (role === "admin") {
                logoutAllBtn.style.display = "inline-block";
            }
        }, 1000);
        // --- X·ª¨ L√ù TR·∫†NG TH√ÅI B·ªä CH·∫∂N (HI·ªÜN NGAY ·ªû √î NH·∫¨P) ---
        const inputWrap = document.querySelector(".input-wrap");
        const msgInputBlocked = document.getElementById("msg");
        const sendBtnBlocked = document.getElementById("sendBtn");

        let isMuted = false;

        onSnapshot(doc(db, "mute", deviceId), (snap) => {
            if (snap.exists()) {
                isMuted = true;

                inputWrap.classList.add("muted");
                msgInputBlocked.disabled = true;
                msgInputBlocked.value = "";
                msgInputBlocked.placeholder = "üö´ T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã ch·∫∑n";
                sendBtnBlocked.disabled = true;
            } else {
                isMuted = false;

                inputWrap.classList.remove("muted");
                msgInputBlocked.disabled = false;
                msgInputBlocked.placeholder = "Nh·∫≠p tin nh·∫Øn...";
                sendBtnBlocked.disabled = false;
            }
        });
        // --- X·ª¨ L√ù N√öT DANH S√ÅCH CH·∫∂N ---
        const toggleMuteBtn = document.getElementById('toggleMuteBtn');
        const muteBox = document.getElementById('muteBox');
        const muteList = document.getElementById('muteList');

        toggleMuteBtn.onclick = () => {
            if (muteBox.style.display === "none") {
                muteBox.style.display = "block";
                loadMuteList(); // G·ªçi h√†m t·∫£i danh s√°ch khi m·ªü
            } else {
                muteBox.style.display = "none";
            }
        };

        // H√†m t·∫£i v√† hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi b·ªã ch·∫∑n t·ª´ Firebase
        async function loadMuteList() {
            onSnapshot(collection(db, "mute"), (snap) => {
                muteList.innerHTML = "";
                if (snap.empty) {
                    muteList.innerHTML = "<div style='font-size:11px; color:#999;'>Ch∆∞a c√≥ ai b·ªã ch·∫∑n.</div>";
                    return;
                }
                snap.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const item = document.createElement("div");
                    item.style = "display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px solid #eee; font-size:12px;";
                    item.innerHTML = `
                    <span>üë§ ${data.name || id}</span>
                    <button onclick="window.unmuteUser('${id}')" style="color:blue; border:none; background:none; cursor:pointer; font-size:11px;">G·ª° ch·∫∑n</button>
                `;
                    muteList.appendChild(item);
                });
            });
        }

        // H√†m g·ª° ch·∫∑n
        window.unmuteUser = async (id) => {
            if (confirm("G·ª° ch·∫∑n ng∆∞·ªùi n√†y?")) {
                await deleteDoc(doc(db, "mute", id));
                showToast("‚úÖ ƒê√£ g·ª° ch·∫∑n!");
            }
        };

        // s·ª≠a l·ªói √¢m thanh th√¥ng b√°o ko ho·∫°t ƒë·ªông
        let audioUnlocked = false;
        const audio = document.getElementById("notifySound");

        function unlockAudio() {
            if (audioUnlocked) return;
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                audioUnlocked = true;
                console.log("üîì Audio unlocked");
            }).catch(() => { });
        }

        // ch·ªâ c·∫ßn 1 l·∫ßn click b·∫•t k·ª≥
        document.addEventListener("click", unlockAudio, { once: true });
        document.addEventListener("touchstart", unlockAudio, { once: true });

        // --- LOGIC B·∫¨T/T·∫ÆT CHAT TO√ÄN SERVER (ƒê√É C·∫¨P NH·∫¨T) ---
        const chatToggleButton = document.getElementById('adminChatToggle');
        let isChatLocked = false;

        onSnapshot(doc(db, "settings", "chatStatus"), (docSnap) => {
            const data = docSnap.exists() ? docSnap.data() : { locked: false };
            isChatLocked = data.locked;

            const msgInput = document.getElementById('msg');
            const sendBtn = document.getElementById('sendBtn');
            const notice = document.getElementById('notice');

            if (isChatLocked) {
                // Giao di·ªán n√∫t cho qu·∫£n tr·ªã
                chatToggleButton.innerText = "üîì M·ªû CHAT";
                chatToggleButton.style.color = "#2ecc71";
                chatToggleButton.style.borderColor = "#2ecc71";

                // C·∫£ Ki·ªÉm duy·ªát v√† Member ƒë·ªÅu th·∫•y d√≤ng n√†y
                notice.innerText = "‚ö†Ô∏è Ph√≤ng chat hi·ªán ƒëang ·ªü ch·∫ø ƒë·ªô CH·ªà XEM.";

                if (role === "member") {
                    // Member b·ªã kh√≥a
                    msgInput.disabled = true;
                    msgInput.placeholder = "H·ªá th·ªëng ƒëang t·∫°m kh√≥a chat...";
                    sendBtn.style.background = "#ccc";
                    sendBtn.style.cursor = "not-allowed";
                } else {
                    // Admin & Ki·ªÉm duy·ªát vi√™n V·∫™N NH·∫ÆN ƒê∆Ø·ª¢C
                    msgInput.disabled = false;
                    msgInput.placeholder = "Chat ƒëang kh√≥a (B·∫°n v·∫´n c√≥ quy·ªÅn g·ª≠i)...";
                    sendBtn.style.background = "var(--primary-color)";
                    sendBtn.style.cursor = "pointer";
                }
            } else {
                // Tr·∫°ng th√°i m·ªü chat b√¨nh th∆∞·ªùng
                chatToggleButton.innerText = "üîí KH√ìA CHAT";
                chatToggleButton.style.color = "#e74c3c";
                chatToggleButton.style.borderColor = "#e74c3c";

                if (!isMuted) {
                    msgInput.disabled = false;
                    msgInput.placeholder = "Nh·∫≠p tin nh·∫Øn...";
                    sendBtn.style.background = "var(--primary-color)";
                    sendBtn.style.cursor = "pointer";
                    notice.innerText = "";
                }
            }
        });
        // S·ª± ki·ªán nh·∫•n n√∫t cho Admin
        chatToggleButton.onclick = async () => {
            if (role !== "admin") return;
            await setDoc(doc(db, "settings", "chatStatus"), {
                locked: !isChatLocked,
                updatedBy: name
            });
            showToast(isChatLocked ? "üîí ƒê√£ kh√≥a chat" : "‚úÖ ƒê√£ m·ªü chat");
        };
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã n√∫t khi load trang (S·ª≠a l·∫°i ƒëo·∫°n setTimeout cu·ªëi c·ªßa b·∫°n)
        setTimeout(() => {
            if (role === "admin") {
                chatToggleButton.style.display = "inline-block";
            }
        }, 1100);

        // --- X·ª¨ L√ù NH·∫§N ENTER ƒê·ªÇ G·ª¨I TIN ---
        const msgInput = document.getElementById('msg');

        msgInput.addEventListener('keydown', (e) => {
            // Ki·ªÉm tra n·∫øu l√† ph√≠m Enter (keyCode 13) v√† kh√¥ng nh·∫•n c√πng ph√≠m Shift
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // NgƒÉn vi·ªác xu·ªëng d√≤ng trong input
                const text = msgInput.value.trim();
                if (text) {
                    sendMsg(text); // G·ªçi h√†m g·ª≠i tin nh·∫Øn
                    msgInput.value = ""; // X√≥a n·ªôi dung input sau khi g·ª≠i
                }
            }
        });
        // H·ªó tr·ª£ th√™m cho c√°c d√≤ng ƒëi·ªán tho·∫°i ƒë·ªùi c≈© (S·ª± ki·ªán submit form)
        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if (text) {
                sendMsg(text);
                msgInput.value = "";
            }
        });

        // H√†m bi·∫øn ch·ªØ th√†nh link c√≥ th·ªÉ b·∫•m ƒë∆∞·ª£c
        const formatText = (text) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, (url) => {
                // text-decoration: none ƒë·ªÉ b·ªè g·∫°ch ch√¢n
                return `<a href="${url}" target="_blank" class="chat-link">${url}</a>`;
            });
        };

        let currentMsgId = null; // L∆∞u ID tin nh·∫Øn c·ª• th·ªÉ

        // --- LOGIC ƒê·ªîI BI·ªÜT DANH ---
        // 1. H√†m m·ªü b·∫£ng
        window.setNickname = (msgId, targetDeviceId, targetRole, currentName) => {
            // ‚ùå B·ªã ch·∫∑n th√¨ c·∫•m ƒë·ªïi bi·ªát danh (ch·ªâ √°p d·ª•ng cho ch√≠nh m√¨nh)
            if (isMuted && targetDeviceId === deviceId) {
                showToast("üö´ B·∫°n ƒëang b·ªã ch·∫∑n, kh√¥ng th·ªÉ ƒë·ªïi bi·ªát danh!");
                return;
            }
            let canEdit = (role === "admin") || (role === "kiemduyet" && targetRole !== "admin") || (targetDeviceId === deviceId);
            if (!canEdit) return alert("‚õî Kh√¥ng c√≥ quy·ªÅn!");

            currentMsgId = msgId; // L∆∞u l·∫°i ID tin nh·∫Øn n√†y
            document.getElementById('targetInfo').innerText = `ƒê·ªïi bi·ªát danh: ${currentName}`;
            document.getElementById('newNicknameInput').value = currentName;
            document.getElementById('nicknameModal').style.display = 'flex';
        };

        // 2. H√†m ƒë√≥ng b·∫£ng
        window.closeNicknameModal = () => {
            document.getElementById('nicknameModal').style.display = 'none';
        };

        // 3. X·ª≠ l√Ω n√∫t X√°c nh·∫≠n (B·∫£n Fix l·ªói Admin b·ªã bi·∫øn th√†nh Member)
        document.getElementById('confirmNicknameBtn').onclick = async () => {
            let newName = document.getElementById('newNicknameInput').value.trim();
            if (!currentMsgId) return window.closeNicknameModal();

            // T·∫°m th·ªùi ƒë√≥ng b·∫£ng ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y chat
            window.closeNicknameModal();

            try {
                const msgRef = doc(db, "messages", currentMsgId);
                const targetMsgDoc = await getDoc(msgRef);

                if (!targetMsgDoc.exists()) return;
                const targetData = targetMsgDoc.data();

                // --- LOGIC 1: CH·∫∂N ƒê·ªîI T√äN BOT ---
                if (targetData.deviceId === "bot") {
                    showToast("‚ùå Kh√¥ng th·ªÉ ƒë·ªïi t√™n h·ªá th·ªëng!");
                    return;
                }

                // --- LOGIC 2: N·∫æU TR·ªêNG TH√å TR·∫¢ V·ªÄ T√äN THEO CH·ª®C V·ª§ ---
                if (newName === "") {
                    if (targetData.role === "admin") {
                        newName = "Admin";
                    } else if (targetData.role === "kiemduyet") {
                        newName = "KiemDuyetVien-" + Math.floor(1000 + Math.random() * 9000);
                    } else {
                        newName = "Member-" + Math.floor(1000 + Math.random() * 9000);
                    }
                }
                showToast("‚è≥ ƒêang l∆∞u...");

                // C·∫≠p nh·∫≠t bi·ªát danh v√†o Firebase
                await setDoc(msgRef, { name: newName }, { merge: true });

                // N·∫øu l√† ch√≠nh m√¨nh th√¨ l∆∞u v√†o m√°y ƒë·ªÉ l·∫ßn sau nh·∫Øn tin d√πng t√™n m·ªõi
                if (targetData.deviceId === deviceId) {
                    localStorage.setItem("memberName", newName);
                }

                showToast("‚úÖ ƒê√£ ƒë·ªïi bi·ªát danh!");
                // n·∫øu l√† ch√≠nh m√¨nh ‚Üí c·∫≠p nh·∫≠t t√™n d√πng cho tin sau
                if (targetData.deviceId === deviceId) {
                    name = newName;
                    localStorage.setItem("memberName", newName);
                    // c·∫≠p nh·∫≠t tr√™n header
                    document.getElementById('roleText').innerText = "üü¢‚îÇT√†i Kho·∫£n: " + name;
                }

            } catch (e) {
                console.error(e);
                alert("L·ªói: " + e.message);
            }
        };
        // ICON
        const emojiBtn = document.getElementById("emojiBtn");
        const emojiPicker = document.getElementById("emojiPicker");
        const msgInput2 = document.getElementById("msg");

        // B·∫≠t / t·∫Øt b·∫£ng emoji
        emojiBtn.onclick = (e) => {
            e.stopPropagation();
            emojiPicker.style.display =
                emojiPicker.style.display === "block" ? "none" : "block";
        };
        // Click ngo√†i th√¨ ƒë√≥ng
        document.addEventListener("click", () => {
            emojiPicker.style.display = "none";
        });
        emojiPicker.onclick = (e) => {
            if (!e.target || e.target.tagName !== "SPAN") return;
            msgInput2.value += e.target.innerText;
            msgInput2.focus();
        };
        // Reply n√®
        window.setReply = (id, name, text) => {
            replyData = { msgId: id, name, text };
            document.getElementById("replyText").innerText =
                `B·∫°n ƒëang tr·∫£ l·ªùi ${name}: ${text.slice(0, 40)}`;
            document.getElementById("replyBox").style.display = "block";
        };

        window.clearReply = () => {
            replyData = null;
            document.getElementById("replyBox").style.display = "none";
        };
        window.scrollToMsg = (msgId) => {
            const el = document.getElementById("msg-" + msgId);
            if (!el) {
                showToast("‚ö†Ô∏è Tin nh·∫Øn g·ªëc kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a");
                return;
            }

            el.scrollIntoView({
                behavior: "smooth",
                block: "center"
            });

            // highlight nh·∫π ƒë·ªÉ d·ªÖ th·∫•y
            el.style.boxShadow = "0 0 0 3px rgba(255,92,168,0.6)";
            setTimeout(() => {
                el.style.boxShadow = "";
            }, 1500);
        };
        // ================= LOGOUT ALL SYSTEM =================
        let lastLogoutVer = Number(localStorage.getItem("lastLogoutVer") || 0);

        onSnapshot(doc(db, "settings", "logoutAll"), (snap) => {
            if (!snap.exists()) return;
            const data = snap.data();

            if (!data.ver) return;
            if (data.ver <= lastLogoutVer) return;

            lastLogoutVer = data.ver;
            localStorage.setItem("lastLogoutVer", lastLogoutVer);

            if (role === "admin" || role === "kiemduyet") {
                showToast("üö® H·ªá th·ªëng y√™u c·∫ßu ƒëƒÉng xu·∫•t!");

                setTimeout(() => {
                    localStorage.removeItem("userRole");
                    localStorage.removeItem("memberName");
                    localStorage.removeItem("isLoggedIn");
                    location.reload();
                }, 800);
            }
        });
    </script>
</body>

</html>
