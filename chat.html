<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:url("https://pomf2.lain.la/f/3qghdbbr.jpg") center/cover fixed;
}
#box{
  max-width:480px;
  margin:auto;
  background:rgba(255,255,255,.95);
  min-height:100vh;
  padding:10px;
}
#messages{
  height:55vh;
  overflow-y:auto;
  border:1px solid #ccc;
  padding:6px;
  background:#fff;
}
input, button{
  width:100%;
  padding:10px;
  margin-top:5px;
  box-sizing:border-box;
}
.msg{
  border-bottom:1px solid #eee;
  padding:6px 0;
  font-size:14px;
}
.msg-head{
  display:flex;
  justify-content:space-between;
}
.name{font-weight:bold}
.admin{color:red}
.kiemduyet{color:green}
.member{color:blue}
.msg.bot .name,.msg.bot .text{color:#ff5ca8}
.ctrls button{
  width:26px;height:26px;padding:0;font-size:13px;
}
.text{
  margin-top:4px;
  white-space:pre-line;
  word-break:break-word;
}
.notice{
  text-align:center;
  color:red;
  font-size:13px;
}
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:8px 14px;
  border-radius:20px;
  opacity:0;
  transition:.3s;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<div id="box">

<div id="loginBox">
  <h3>ƒêƒÉng nh·∫≠p</h3>
  <input id="user" placeholder="T√†i kho·∫£n">
  <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u">
  <button id="loginBtn">ƒêƒÉng nh·∫≠p</button>
  <hr>
  <button id="guestBtn">V√†o v·ªõi t∆∞ c√°ch Member</button>
</div>

<div id="chatBox" style="display:none">
  <h3 id="roleText"></h3>
  <button id="soundBtn">üîä √Çm thanh: B·∫¨T</button>
  <div id="notice" class="notice"></div>
  <div id="messages"></div>
  <input id="msg" placeholder="Nh·∫≠p tin nh·∫Øn">
  <button id="sendBtn">G·ª≠i</button>
</div>

</div>

<audio id="notifySound" src="boa.mp3"></audio>

<script>
let role="",name="";
let soundOn=localStorage.getItem("soundOn")!=="false";

let deviceId=localStorage.getItem("deviceId");
if(!deviceId){
  deviceId=crypto.randomUUID();
  localStorage.setItem("deviceId",deviceId);
}

loginBtn.onclick=()=>{
  if(user.value==="admin1409" && pass.value==="140907"){
    role="admin";name="Admin";start();
  }else if(user.value==="kiemduyet2007" && pass.value==="678678"){
    role="kiemduyet";name="Ki·ªÉm duy·ªát";start();
  }else alert("Sai t√†i kho·∫£n");
};

guestBtn.onclick=()=>{
  role="member";
  name="Member-"+Math.floor(Math.random()*1000);
  start();
};

function start(){
  loginBox.style.display="none";
  chatBox.style.display="block";
  roleText.innerText="B·∫°n l√†: "+name;
  soundBtn.innerText=soundOn?"üîä √Çm thanh: B·∫¨T":"üîá √Çm thanh: T·∫ÆT";
  soundBtn.onclick=()=>{
    soundOn=!soundOn;
    localStorage.setItem("soundOn",soundOn);
    soundBtn.innerText=soundOn?"üîä √Çm thanh: B·∫¨T":"üîá √Çm thanh: T·∫ÆT";
  };
  initChat();
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, serverTimestamp,
  doc, getDoc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyAOqWngNA4k7bMi0c7rfBbXAHfcB2g9LJM",
  authDomain:"gaconmc.firebaseapp.com",
  projectId:"gaconmc",
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const q=query(collection(db,"messages"),orderBy("time"));

window.initChat=()=>{
  checkMute();

  onSnapshot(q,snap=>{
    snap.docChanges().forEach(c=>{
      if(c.type!=="added") return;
      const m=c.doc.data();

      if(soundOn && m.deviceId!=="bot"){
        notifySound.currentTime=0;
        notifySound.play().catch(()=>{});
      }

      const div=document.createElement("div");
      div.className=`msg ${m.role} ${m.deviceId==="bot"?"bot":""}`;
      div.innerHTML=`
        <div class="msg-head">
          <div class="name">${m.name}</div>
          <div class="ctrls">
            <button onclick="copyText('${m.text.replace(/'/g,"")}')">üìã</button>
            ${role!=="member"?`
              <button onclick="delMsg('${c.doc.id}')">‚ùå</button>
              <button onclick="mute('${m.deviceId}','${m.name}')">üö´</button>
            `:""}
          </div>
        </div>
        <div class="text">${m.text}</div>
      `;
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    });
  });

  sendBtn.onclick=async()=>{
    if(!msg.value) return;
    if(role==="member"){
      const m=await getDoc(doc(db,"mute",deviceId));
      if(m.exists()) return alert("B·∫°n ƒëang b·ªã ch·∫∑n chat");
    }
    await addDoc(collection(db,"messages"),{
      name,role,text:msg.value,
      deviceId,time:serverTimestamp()
    });
    msg.value="";
  };
};

async function checkMute(){
  if(role!=="member") return;
  const m=await getDoc(doc(db,"mute",deviceId));
  if(m.exists()){
    msg.disabled=true;
    sendBtn.disabled=true;
    notice.innerText="üö´ B·∫°n ƒëang b·ªã ch·∫∑n chat";
  }
}

/* ü§ñ BOT ‚Äì ANTI SPAM FIX */

let lastMemberTime = 0;
let lastBotReplyTime = 0;

const IDLE = 300000;      // 5 ph√∫t
const COOLDOWN = 300000; // 5 ph√∫t
const startTime = Date.now();

onSnapshot(q, async snap => {
  for (const c of snap.docChanges()) {
    if (c.type !== "added") continue;

    const m = c.doc.data();

    // ‚ùå b·ªè qua bot
    if (m.deviceId === "bot") continue;

    // ‚ùå b·ªè qua tin c≈©
    if (m.time?.toMillis && m.time.toMillis() < startTime) continue;

    // ‚ùå ch·ªâ ph·∫£n h·ªìi MEMBER
    if (m.role !== "member") continue;

    const now = Date.now();

    const isStrange = /^Member-\d+$/.test(m.name);
    const isIdle = lastMemberTime !== 0 && now - lastMemberTime > IDLE;
    const isCooldown = now - lastBotReplyTime < COOLDOWN;

    // ‚ùå ƒëang cooldown ‚Üí kh√¥ng l√†m g√¨
    if (isCooldown) {
      lastMemberTime = now;
      continue;
    }

    // ‚úÖ ƒë·ªß ƒëi·ªÅu ki·ªán ‚Üí bot tr·∫£ l·ªùi
    if (isStrange || isIdle) {
      lastBotReplyTime = now;

      // TIN 1
      await addDoc(collection(db, "messages"), {
        name: "ü§ñ Bot",
        role: "admin",
        deviceId: "bot",
        time: serverTimestamp(),
        text: "Hello üëã hi·ªán t·∫°i kh√¥ng c√≥ ai online, b·∫°n ƒë·ª£i ch√∫t ·∫°."
      });

      // TIN 2
      await addDoc(collection(db, "messages"), {
        name: "ü§ñ Bot",
        role: "admin",
        deviceId: "bot",
        time: serverTimestamp(),
        text: "üëâ https://fb.com"
      });
    }

    // ‚úÖ lu√¥n c·∫≠p nh·∫≠t sau c√πng
    lastMemberTime = now;
  }
});

/* ================= üìå COMMAND HANDLER ‚Äì OPTIMIZED ================= */

const commandStartTime = Date.now();

onSnapshot(
  query(collection(db, "messages"), orderBy("time")),
  async snap => {

    for (const c of snap.docChanges()) {
      if (c.type !== "added") continue;

      const m = c.doc.data();

      // ‚ùå b·ªè qua bot
      if (m.deviceId === "bot") continue;

      // ‚ùå b·ªè qua tin c≈© tr∆∞·ªõc khi load trang
      if (m.time?.toMillis && m.time.toMillis() < commandStartTime) continue;

      // ‚ùå kh√¥ng c√≥ text
      if (!m.text) continue;

      // chu·∫©n ho√° l·ªánh
      const cmd = m.text.trim().toLowerCase();

      /* ======= /info ======= */
      if (cmd !== "/info") continue;

      await addDoc(collection(db, "messages"), {
        name: "ü§ñ Bot",
        role: "admin",
        deviceId: "bot",
        time: serverTimestamp(),
        text:
`üìå INFO C√ÅC CH·ª®C V·ª§ SERVER

üë§ Admin Ch√≠nh:
üëâ Facebook: https://www.facebook.com/profile.php?id=61583009645768

üë§ Admin Ph·ª•:
üëâ Facebook: https://www.facebook.com/thu.trang.1401207

üë§ C√°c QTV:
üëâ Facebook: https://www.facebook.com/MrSomeOne1
üëâ Facebook: https://www.facebook.com/profile.php?id=61582928121714

üë§ C√°c Support:
üëâ Facebook: https://www.facebook.com/le.tuan.anh.347063
üëâ Facebook: https://www.facebook.com/nguyen.chi.anh.853868
üëâ Facebook: https://www.facebook.com/profile.php?id=61574102743872

‚ù§Ô∏è H√£y li√™n h·ªá nh·ªØng ng∆∞·ªùi tr√™n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ ‚ù§Ô∏è`
      });
    }
  }
);

/* =============================================================== */



/* utils */
window.copyText=t=>{
  navigator.clipboard.writeText(t);
  toast("üìã ƒê√£ copy");
};
window.delMsg=id=>deleteDoc(doc(db,"messages",id));
window.mute=(id,name)=>setDoc(doc(db,"mute",id),{name});

function toast(t){
  const d=document.createElement("div");
  d.className="toast";
  d.innerText=t;
  document.body.appendChild(d);
  setTimeout(()=>d.classList.add("show"),10);
  setTimeout(()=>d.remove(),1200);
}
</script>

</body>
</html>
